<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenClaw Configurator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        body { background-color: #f3f4f6; }
    </style>
</head>
<body class="text-gray-800">
    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-slate-900 text-white p-4 shadow-lg">
            <div class="container mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span class="text-2xl">ðŸ¦ž</span>
                    <h1 class="text-xl font-bold">OpenClaw <span class="font-light opacity-80">Configurator</span></h1>
                </div>
                <div class="text-sm opacity-70">Localhost Mode</div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow container mx-auto p-6 max-w-3xl">
            
            <!-- Step Progress -->
            <div class="mb-8 flex justify-between items-center px-4 relative">
                <div class="absolute left-0 top-1/2 w-full h-1 bg-gray-300 -z-10 rounded"></div>
                <div v-for="s in steps" :key="s.id" 
                     class="flex flex-col items-center bg-gray-100 p-2 rounded cursor-pointer transition"
                     :class="{'text-blue-600 font-bold': currentStep >= s.id}">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center mb-1 border-2"
                         :class="currentStep >= s.id ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-400 border-gray-300'">
                        {{ s.id }}
                    </div>
                    <span class="text-xs">{{ s.label }}</span>
                </div>
            </div>

            <!-- Views -->
            <div class="bg-white rounded-xl shadow-md p-8 min-h-[400px]">
                
                <!-- Step 1: Provider -->
                <div v-if="currentStep === 1">
                    <h2 class="text-2xl font-bold mb-4">Choose Your Brain ðŸ§ </h2>
                    <p class="text-gray-500 mb-6">Select the primary AI provider for OpenClaw.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div v-for="p in providers" :key="p.id"
                             @click="selectProvider(p)"
                             class="border-2 rounded-lg p-4 cursor-pointer hover:border-blue-500 hover:bg-blue-50 transition flex items-center gap-4"
                             :class="config.provider === p.id ? 'border-blue-600 bg-blue-50 ring-2 ring-blue-200' : 'border-gray-200'">
                            <div class="text-2xl">{{ p.icon }}</div>
                            <div>
                                <div class="font-bold">{{ p.name }}</div>
                                <div class="text-xs text-gray-500">{{ p.desc }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Credentials -->
                <div v-if="currentStep === 2">
                    <h2 class="text-2xl font-bold mb-4">Credentials ðŸ”‘</h2>
                    <p class="text-gray-500 mb-6">Configure access for {{ getProviderName() }}.</p>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">API Key</label>
                            <input type="password" v-model="config.apiKey" 
                                   class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none"
                                   placeholder="sk-...">
                        </div>

                        <div>
                            <label class="block text-sm font-medium mb-1">Base URL</label>
                            <input type="text" v-model="config.baseUrl" 
                                   class="w-full p-3 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50">
                            <p class="text-xs text-gray-400 mt-1">Change this if you use a proxy or custom endpoint.</p>
                        </div>

                        <!-- Verification Area -->
                        <div class="mt-6 p-4 rounded-lg border transition-all"
                             :class="verifyStatus.class">
                            <div class="flex items-center justify-between">
                                <span class="font-bold flex items-center gap-2">
                                    <i class="fas" :class="verifyStatus.icon"></i>
                                    {{ verifyStatus.text }}
                                </span>
                                <button @click="verifyKey" 
                                        :disabled="verifying || !config.apiKey"
                                        class="px-4 py-2 bg-slate-800 text-white rounded hover:bg-slate-700 disabled:opacity-50 disabled:cursor-not-allowed text-sm">
                                    {{ verifying ? 'Checking...' : 'Test Connection' }}
                                </button>
                            </div>
                            <p v-if="verifyMsg" class="text-xs mt-2 font-mono whitespace-pre-wrap">{{ verifyMsg }}</p>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Models (Router) -->
                <div v-if="currentStep === 3">
                    <h2 class="text-2xl font-bold mb-4">Model Router ðŸ”€</h2>
                    <p class="text-gray-500 mb-6">Define fallback strategies for reliability.</p>

                    <div class="space-y-6">
                        <!-- Primary -->
                        <div>
                            <label class="block text-sm font-bold text-blue-600 mb-2">PRIMARY MODEL</label>
                            <div class="flex gap-2">
                                <input type="text" v-model="config.primaryModel" class="flex-1 p-2 border rounded">
                                <select v-model="config.primaryModel" class="p-2 border rounded bg-gray-50 w-32">
                                    <option v-for="m in recommendedModels" :value="m">{{ m }}</option>
                                </select>
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Main model for complex tasks.</p>
                        </div>

                        <!-- Fallback -->
                        <div>
                            <label class="block text-sm font-bold text-orange-600 mb-2">FALLBACK MODEL (Optional)</label>
                            <div class="flex gap-2">
                                <input type="text" v-model="config.fallbackModel" class="flex-1 p-2 border rounded" placeholder="e.g. gpt-3.5-turbo">
                            </div>
                            <p class="text-xs text-gray-400 mt-1">Used if Primary fails or for cheaper tasks.</p>
                        </div>
                    </div>
                </div>

                <!-- Step 4: Finish -->
                <div v-if="currentStep === 4" class="text-center py-10">
                    <div class="text-6xl mb-4">ðŸŽ‰</div>
                    <h2 class="text-3xl font-bold mb-2">Ready to Launch!</h2>
                    <p class="text-gray-500 mb-8">Your configuration has been generated.</p>
                    
                    <div class="bg-gray-900 text-gray-300 p-4 rounded-lg text-left text-sm font-mono mb-8 overflow-auto max-h-48">
                        {{ JSON.stringify(finalConfig, null, 2) }}
                    </div>

                    <button @click="saveConfig" 
                            class="w-full py-4 bg-green-600 text-white rounded-xl text-xl font-bold hover:bg-green-700 shadow-lg transform hover:-translate-y-1 transition">
                        Save & Apply Config ðŸš€
                    </button>
                </div>

            </div>

            <!-- Navigation -->
            <div class="flex justify-between mt-6">
                <button @click="currentStep--" 
                        v-if="currentStep > 1"
                        class="px-6 py-2 text-gray-500 hover:text-gray-800 font-bold">
                    &larr; Back
                </button>
                <div class="flex-grow"></div>
                <button @click="nextStep" 
                        v-if="currentStep < 4"
                        class="px-8 py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 shadow transition">
                    Next &rarr;
                </button>
            </div>

        </main>
    </div>

    <script>
        const { createApp, ref, computed } = Vue;

        createApp({
            setup() {
                const currentStep = ref(1);
                const verifying = ref(false);
                const verifyResult = ref(null); // { ok: bool, msg: string }

                const steps = [
                    { id: 1, label: 'Provider' },
                    { id: 2, label: 'Credentials' },
                    { id: 3, label: 'Routing' },
                    { id: 4, label: 'Deploy' }
                ];

                const providers = [
                    { id: 'openai', name: 'OpenAI', icon: 'ðŸ¤–', desc: 'Standard GPT models' },
                    { id: 'anthropic', name: 'Anthropic', icon: 'ðŸ§ ', desc: 'Claude 3.5 Sonnet/Opus' },
                    { id: 'google', name: 'Google Gemini', icon: 'ðŸ’Ž', desc: 'Gemini Pro / Flash' },
                    { id: 'custom', name: 'Custom / OneAPI', icon: 'ðŸ”Œ', desc: 'Local models or proxies' }
                ];

                const config = ref({
                    provider: 'openai',
                    apiKey: '',
                    baseUrl: 'https://api.openai.com/v1',
                    primaryModel: 'gpt-4o',
                    fallbackModel: ''
                });

                // Computed Helpers
                const getProviderName = () => providers.find(p => p.id === config.value.provider)?.name;
                
                const recommendedModels = computed(() => {
                    if (config.value.provider === 'openai') return ['gpt-4o', 'gpt-4-turbo', 'gpt-3.5-turbo'];
                    if (config.value.provider === 'anthropic') return ['claude-3-5-sonnet-20240620', 'claude-3-opus-20240229'];
                    if (config.value.provider === 'google') return ['gemini-1.5-pro', 'gemini-1.5-flash'];
                    return [];
                });

                // Status UI
                const verifyStatus = computed(() => {
                    if (!verifyResult.value) return { text: 'Not Verified', class: 'bg-gray-50 border-gray-200 text-gray-500', icon: 'fa-circle' };
                    if (verifyResult.value.ok) return { text: 'Connection Successful', class: 'bg-green-50 border-green-200 text-green-700', icon: 'fa-check-circle' };
                    return { text: 'Connection Failed', class: 'bg-red-50 border-red-200 text-red-700', icon: 'fa-times-circle' };
                });
                
                const verifyMsg = computed(() => verifyResult.value?.msg || '');

                // Methods
                const selectProvider = (p) => {
                    config.value.provider = p.id;
                    if (p.id === 'openai') config.value.baseUrl = 'https://api.openai.com/v1';
                    if (p.id === 'anthropic') config.value.baseUrl = 'https://api.anthropic.com/v1';
                    if (p.id === 'google') config.value.baseUrl = 'https://generativelanguage.googleapis.com/v1beta';
                    
                    // Reset models
                    config.value.primaryModel = recommendedModels.value[0] || '';
                };

                const verifyKey = async () => {
                    verifying.value = true;
                    verifyResult.value = null;
                    
                    try {
                        const res = await fetch('/api/verify', {
                            method: 'POST',
                            body: JSON.stringify(config.value)
                        });
                        const data = await res.json();
                        
                        if (data.success) {
                            verifyResult.value = { ok: true, msg: 'API responded correctly.' };
                        } else {
                            verifyResult.value = { ok: false, msg: JSON.stringify(data.error, null, 2) };
                        }
                    } catch (e) {
                        verifyResult.value = { ok: false, msg: e.message };
                    } finally {
                        verifying.value = false;
                    }
                };

                const nextStep = () => {
                    if (currentStep.value === 2 && !verifyResult.value?.ok && config.value.apiKey) {
                        if (!confirm('API verification was skipped or failed. Continue anyway?')) return;
                    }
                    currentStep.value++;
                };

                const finalConfig = computed(() => {
                    const c = config.value;
                    return {
                        meta: { lastTouchedBy: "openclaw-toolkit-web" },
                        gateway: { port: 18789, mode: "local", auth: { mode: "token", token: "generated-token-" + Date.now() } },
                        auth: { profiles: { default: { provider: c.provider, mode: "api_key" } } },
                        models: {
                            providers: {
                                default: {
                                    baseUrl: c.baseUrl,
                                    apiKey: c.apiKey,
                                    api: c.provider === 'openai' ? 'openai-completions' : (c.provider === 'anthropic' ? 'anthropic-messages' : 'google-generative-ai'),
                                    models: [
                                        { id: c.primaryModel, name: c.primaryModel, reasoning: false },
                                        ...(c.fallbackModel ? [{ id: c.fallbackModel, name: c.fallbackModel, reasoning: false }] : [])
                                    ]
                                }
                            }
                        },
                        agents: { defaults: { model: { primary: `default/${c.primaryModel}`, fallbacks: c.fallbackModel ? [`default/${c.fallbackModel}`] : [] } } }
                    };
                });

                const saveConfig = async () => {
                    try {
                        const res = await fetch('/api/config', {
                            method: 'POST',
                            body: JSON.stringify(finalConfig.value)
                        });
                        const data = await res.json();
                        if (data.success) {
                            alert('Config saved successfully! Please restart OpenClaw.');
                        } else {
                            alert('Error saving config: ' + data.error);
                        }
                    } catch (e) {
                        alert('Error: ' + e.message);
                    }
                };

                return {
                    currentStep, steps, providers, config, verifying, verifyStatus, verifyMsg,
                    selectProvider, getProviderName, verifyKey, nextStep, recommendedModels, finalConfig, saveConfig
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
